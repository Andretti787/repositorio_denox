<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>carga_consumos_fabrica_TRILLA</name>
    <description />
    <extended_description />
    <trans_version />
    <trans_type>Normal</trans_type>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection />
        <schema />
        <table />
        <size_limit_lines />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject />
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject />
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject />
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject />
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection />
        <schema />
        <table />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection />
      <table />
      <field />
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file />
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2022/12/15 11:57:12.439</created_date>
    <modified_user>-</modified_user>
    <modified_date>2022/12/15 11:57:12.439</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>MSSQL V12</name>
    <server>192.168.28.100</server>
    <type>MSSQLNATIVE</type>
    <access>Native</access>
    <database>x3</database>
    <port>51439</port>
    <username>it</username>
    <password>Encrypted 2be98afc86aa7b2a2aa14ab63dfc3fd89</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>MSSQLUseIntegratedSecurity</code>
        <attribute>false</attribute>
      </attribute>
      <attribute>
        <code>MSSQL_DOUBLE_DECIMAL_SEPARATOR</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>51439</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>MySQL</name>
    <server>192.168.35.25</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>mariodb</database>
    <port>3306</port>
    <username>mmarco</username>
    <password>Encrypted 2be98afc86aa7b2b7b20aba75d3c1fb8f</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>Table input</from>
      <to>Select values</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Select values</from>
      <to>Table output</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Table input 2</from>
      <to>Selecciona/Renombra valores</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Selecciona/Renombra valores</from>
      <to>Table output 2</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Table input 2 2</from>
      <to>Selecciona/Renombra valores 2</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Selecciona/Renombra valores 2</from>
      <to>Table output 2 2</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Selecciona/Renombra valores</name>
    <type>SelectValues</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <fields>
      <field>
        <name>STOFCY_0</name>
      </field>
      <field>
        <name>FECHA</name>
      </field>
      <field>
        <name>COMPONENTE</name>
      </field>
      <field>
        <name>CANTIDAD_COMPONENTE</name>
      </field>
      <field>
        <name>MEDIDA</name>
      </field>
      <select_unspecified>N</select_unspecified>
      <meta>
        <name>FECHA</name>
        <rename>FECHA</rename>
        <type>Date</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>yyyyMM</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale />
        <date_format_timezone />
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding />
        <decimal_symbol />
        <grouping_symbol />
        <currency_symbol />
        <storage_type />
      </meta>
    </fields>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>368</xloc>
      <yloc>192</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Selecciona/Renombra valores 2</name>
    <type>SelectValues</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <fields>
      <field>
        <name>STOFCY_0</name>
      </field>
      <field>
        <name>FECHA</name>
      </field>
      <field>
        <name>ITMREF_0</name>
      </field>
      <field>
        <name>CANTIDAD_PRODUCIDA</name>
      </field>
      <field>
        <name>COMPONENTE</name>
      </field>
      <field>
        <name>CANTIDAD_COMPONENTE</name>
      </field>
      <field>
        <name>MEDIDA</name>
      </field>
      <field>
        <name>ORIGEN</name>
      </field>
      <select_unspecified>N</select_unspecified>
      <meta>
        <name>FECHA</name>
        <rename>FECHA</rename>
        <type>Date</type>
        <length>-2</length>
        <precision>-2</precision>
        <conversion_mask>yyyyMM</conversion_mask>
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale />
        <date_format_timezone />
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding />
        <decimal_symbol />
        <grouping_symbol />
        <currency_symbol />
        <storage_type />
      </meta>
      <meta>
        <name>CANTIDAD_PRODUCIDA</name>
        <rename>CANTIDAD_PRODUCIDA</rename>
        <type>Number</type>
        <length>-2</length>
        <precision>2</precision>
        <conversion_mask />
        <date_format_lenient>false</date_format_lenient>
        <date_format_locale />
        <date_format_timezone />
        <lenient_string_to_number>false</lenient_string_to_number>
        <encoding />
        <decimal_symbol />
        <grouping_symbol />
        <currency_symbol />
        <storage_type />
      </meta>
    </fields>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>368</xloc>
      <yloc>320</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Select values</name>
    <type>SelectValues</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <fields>
      <field>
        <name>FECHA_NECESIDAD</name>
      </field>
      <field>
        <name>MATERIAL</name>
      </field>
      <field>
        <name>DESCRIP_MATERIAL</name>
      </field>
      <field>
        <name>CONSUMO_TEORICO</name>
      </field>
      <field>
        <name>CONSUMO_REAL</name>
      </field>
      <field>
        <name>PERCENTIL_CONSUMO</name>
      </field>
      <field>
        <name>UNIDAD_MEDIDA</name>
      </field>
      <field>
        <name>PLANTA</name>
      </field>
      <select_unspecified>N</select_unspecified>
    </fields>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>368</xloc>
      <yloc>16</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table input</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>MSSQL V12</connection>
    <sql>SELECT  MFG.PLNFCY_0 COLLATE Latin1_General_BIN2 AS PLANTA, 
/*MFG.MFGNUM_0, */FORMAT(MAT.RETDAT_0,'yyyy/MM') AS FECHA_NECESIDAD/*, MAT.TRKFIRST_0,  MAT.TRKLAST_0,  DATEDIFF(day, MAT.TRKFIRST_0, MAT.TRKLAST_0) AS DIF*/
--FORMAT(SEG.IPTDAT_0,'yyyy/MM') AS FECHA_SEGUIMIENTO
/*, LIVE.ZFUNCMENUITEM ('317', MFG.MFGSTA_0,'SPA') AS ESTADO_ORDEN*/
, MAT.ITMREF_0 COLLATE Latin1_General_BIN2 AS MATERIAL, ITM.ITMDES1_0 COLLATE Latin1_General_BIN2 AS DESCRIP_MATERIAL 
/*, LIVE.ZFUNCMENUITEM('363', MAT.MFGSTA_0,'SPA') AS ESTADO_MATERIAL*/
--, SUM(MAT.RETQTY_0) OVER (PARTITION BY MAT.ITMREF_0)  AS CONSUMO_TEO
, SUM(MAT.RETQTY_0) AS CONSUMO_TEORICO, SUM(MAT.USEQTY_0) AS CONSUMO_REAL
, CASE SUM(MAT.USEQTY_0) WHEN 0 
				THEN 0 
				ELSE CAST((SUM(MAT.USEQTY_0) / SUM(MAT.RETQTY_0)) * 100  AS DECIMAL(10,2)) END AS PERCENTIL_CONSUMO
,  MAT.BOMUOM_0 COLLATE Latin1_General_BIN2 AS UNIDAD_MEDIDA
fROM [192.168.28.200\X3FAMESA].x3famesa.FAMESAOF.MFGMAT MAT
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.FAMESAOF.MFGOPE OPE ON OPE.MFGNUM_0 = MAT.MFGNUM_0  AND OPE.OPESTA_0 &lt;&gt; 6
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.FAMESAOF.WORKSTATIO STA ON STA.WST_0 = OPE.STDWST_0 AND  STA.WCRFCY_0 = 'FAM' AND STA.WCR_0 &lt;&gt; 'SERIG' --QUITO MÁQUINAS DE ACABADOS
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.FAMESAOF.MFGHEAD MFG ON MFG.MFGNUM_0 = MAT.MFGNUM_0
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.FAMESAOF.ITMFACILIT ITF ON ITF.ITMREF_0 = MAT.ITMREF_0 AND ITF.STOFCY_0 = MAT.PLNFCY_0
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.FAMESAOF.ITMMASTER ITM ON ITM.ITMREF_0 = MAT.ITMREF_0  
--WHERE MAT.BOMUOM_0 = 'KG'
--AND MFG.PLNFCY_0 = 'TRI' 
WHERE MATSTA_0 &lt;&gt; 4 --QUITO MATERIALES EXCLUIDOS
GROUP BY GROUPING SETS (
       (MFG.PLNFCY_0, FORMAT(MAT.RETDAT_0,'yyyy/MM'), MAT.ITMREF_0, ITM.ITMDES1_0, MAT.BOMUOM_0),
       (MFG.PLNFCY_0, FORMAT(MAT.RETDAT_0,'yyyy/MM')),
	   (MFG.PLNFCY_0), 
       ()
      )
UNION ALL
SELECT MFG.PLNFCY_0 COLLATE Latin1_General_BIN2 AS PLANTA, 
/*MFG.MFGNUM_0, */FORMAT(MAT.RETDAT_0,'yyyy/MM') AS FECHA_NECESIDAD/*, MAT.TRKFIRST_0,  MAT.TRKLAST_0,  DATEDIFF(day, MAT.TRKFIRST_0, MAT.TRKLAST_0) AS DIF*/
--FORMAT(SEG.IPTDAT_0,'yyyy/MM') AS FECHA_SEGUIMIENTO
/*, LIVE.ZFUNCMENUITEM ('317', MFG.MFGSTA_0,'SPA') AS ESTADO_ORDEN*/
, MAT.ITMREF_0 COLLATE Latin1_General_BIN2 AS MATERIAL, ITM.ITMDES1_0 COLLATE Latin1_General_BIN2 AS DESCRIP_MATERIAL 
/*, LIVE.ZFUNCMENUITEM('363', MAT.MFGSTA_0,'SPA') AS ESTADO_MATERIAL*/
--, SUM(MAT.RETQTY_0) OVER (PARTITION BY MAT.ITMREF_0)  AS CONSUMO_TEO
, SUM(MAT.RETQTY_0) AS CONSUMO_TEORICO, SUM(MAT.USEQTY_0) AS CONSUMO_REAL
, CASE SUM(MAT.USEQTY_0) WHEN 0 
				THEN 0 
				ELSE CAST((SUM(MAT.USEQTY_0) / SUM(MAT.RETQTY_0)) * 100  AS DECIMAL(10,2)) END AS PERCENTIL_CONSUMO
,  MAT.BOMUOM_0 COLLATE Latin1_General_BIN2 AS UNIDAD_MEDIDA
fROM [192.168.28.200\X3FAMESA].x3famesa.TRILLA.MFGMAT MAT
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.TRILLA.MFGOPE OPE ON OPE.MFGNUM_0 = MAT.MFGNUM_0  AND OPE.OPESTA_0 &lt;&gt; 6
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.TRILLA.WORKSTATIO STA ON STA.WST_0 = OPE.STDWST_0 AND  STA.WCRFCY_0 = 'TRI' AND STA.WCR_0 &lt;&gt; 'SERIG' --QUITO MÁQUINAS DE ACABADOS
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.TRILLA.MFGHEAD MFG ON MFG.MFGNUM_0 = MAT.MFGNUM_0
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.TRILLA.ITMFACILIT ITF ON ITF.ITMREF_0 = MAT.ITMREF_0 AND ITF.STOFCY_0 = MAT.PLNFCY_0
INNER JOIN [192.168.28.200\X3FAMESA].x3famesa.TRILLA.ITMMASTER ITM ON ITM.ITMREF_0 = MAT.ITMREF_0  
--WHERE MAT.BOMUOM_0 = 'KG'
--AND MFG.PLNFCY_0 = 'TRI' 
WHERE MATSTA_0 &lt;&gt; 4 --QUITO MATERIALES EXCLUIDOS
GROUP BY GROUPING SETS (
       (MFG.PLNFCY_0, FORMAT(MAT.RETDAT_0,'yyyy/MM'), MAT.ITMREF_0, ITM.ITMDES1_0, MAT.BOMUOM_0),
       (MFG.PLNFCY_0, FORMAT(MAT.RETDAT_0,'yyyy/MM')),
	   (MFG.PLNFCY_0), 
       ()
      )
UNION ALL
SELECT MFG.PLNFCY_0 COLLATE Latin1_General_BIN2 AS PLANTA, 
/*MFG.MFGNUM_0, */FORMAT(MAT.RETDAT_0,'yyyy/MM') AS FECHA_NECESIDAD/*, MAT.TRKFIRST_0,  MAT.TRKLAST_0,  DATEDIFF(day, MAT.TRKFIRST_0, MAT.TRKLAST_0) AS DIF*/
--FORMAT(SEG.IPTDAT_0,'yyyy/MM') AS FECHA_SEGUIMIENTO
/*, LIVE.ZFUNCMENUITEM ('317', MFG.MFGSTA_0,'SPA') AS ESTADO_ORDEN*/
, MAT.ITMREF_0 AS MATERIAL, ITM.ITMDES1_0 AS DESCRIP_MATERIAL
/*, LIVE.ZFUNCMENUITEM('363', MAT.MFGSTA_0,'SPA') AS ESTADO_MATERIAL*/
--, SUM(MAT.RETQTY_0) OVER (PARTITION BY MAT.ITMREF_0)  AS CONSUMO_TEO
, SUM(MAT.RETQTY_0) AS CONSUMO_TEORICO, SUM(MAT.USEQTY_0) AS CONSUMO_REAL
, CASE SUM(MAT.USEQTY_0) WHEN 0 
				THEN 0 
				ELSE CAST((SUM(MAT.USEQTY_0) / SUM(MAT.RETQTY_0)) * 100  AS DECIMAL(10,2)) END AS PERCENTIL_CONSUMO
--, SUM(SEG.USEQTY_0) AS CONSUMO_SEGUIMIENTO
,  MAT.BOMUOM_0 AS UNIDAD_MEDIDA
fROM LIVE.MFGMAT MAT
INNER JOIN LIVE.MFGOPE OPE ON OPE.MFGNUM_0 = MAT.MFGNUM_0  AND OPE.OPESTA_0 &lt;&gt; 6
INNER JOIN LIVE.WORKSTATIO STA ON STA.WST_0 = OPE.STDWST_0 /*AND  STA.WCRFCY_0 = 'TRI'*/ AND STA.WCR_0 &lt;&gt; 'SERIG' --QUITO MÁQUINAS DE ACABADOS
INNER JOIN LIVE.MFGHEAD MFG ON MFG.MFGNUM_0 = MAT.MFGNUM_0
INNER JOIN LIVE.ITMFACILIT ITF ON ITF.ITMREF_0 = MAT.ITMREF_0 AND ITF.STOFCY_0 = MAT.PLNFCY_0
INNER JOIN LIVE.ITMMASTER ITM ON ITM.ITMREF_0 = MAT.ITMREF_0  
--LEFT JOIN LIVE.MFGMATTRK SEG ON SEG.MFGNUM_0 = MAT.MFGNUM_0 AND SEG.ITMREF_0 = MAT.ITMREF_0 
--WHERE MFG.MFGNUM_0 = 'OFTRI220904311'
--WHERE MAT.BOMUOM_0 = 'KG'
/*AND MFG.PLNFCY_0 = 'TRI' */
WHERE MATSTA_0 &lt;&gt; 4 --QUITO MATERIALES EXCLUIDOS
GROUP BY GROUPING SETS (
       (MFG.PLNFCY_0,FORMAT(MAT.RETDAT_0,'yyyy/MM'), MAT.ITMREF_0, ITM.ITMDES1_0, MAT.BOMUOM_0),
       (MFG.PLNFCY_0,FORMAT(MAT.RETDAT_0,'yyyy/MM')),
	   (MFG.PLNFCY_0), 
       ()
      )
</sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>128</xloc>
      <yloc>16</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table input 2</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>MSSQL V12</connection>
    <sql>SELECT JOU.STOFCY_0
, FORMAT(JOU.IPTDAT_0, 'yyyyMM') AS FECHA
, ZDE.COMPONENTE
, SUM(ZDE.QTY_UNI * JOU.QTYSTU_0) AS CANTIDAD_COMPONENTE
, ZDE.MEDIDA
FROM LIVE.STOJOU JOU
LEFT JOIN LIVE.ZDESCOMPOSICION_ARTI ZDE ON ZDE.RAIZ = JOU.ITMREF_0
WHERE JOU.TRSTYP_0 = 5 --ENTRADAS OF
AND ZDE.NIVEL = 0
GROUP BY JOU.STOFCY_0, FORMAT(JOU.IPTDAT_0, 'yyyyMM'), ZDE.COMPONENTE, ZDE.MEDIDA</sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>128</xloc>
      <yloc>192</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table input 2 2</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>MSSQL V12</connection>
    <sql>SELECT JOU.STOFCY_0
, FORMAT(JOU.IPTDAT_0, 'yyyyMM') AS FECHA
, JOU.ITMREF_0
, SUM(JOU.QTYSTU_0) AS CANTIDAD_PRODUCIDA
, ZDE.COMPONENTE
, SUM(ZDE.QTY_UNI * JOU.QTYSTU_0) AS CANTIDAD_COMPONENTE
, ZDE.MEDIDA
, JOU.VCRNUMORI_0 AS ORIGEN
FROM LIVE.STOJOU JOU
LEFT JOIN LIVE.ZDESCOMPOSICION_ARTI ZDE ON ZDE.RAIZ = JOU.ITMREF_0
WHERE JOU.TRSTYP_0 = 5 --ENTRADAS OF
AND ZDE.NIVEL = 0
GROUP BY JOU.STOFCY_0, FORMAT(JOU.IPTDAT_0, 'yyyyMM'), JOU.ITMREF_0, ZDE.COMPONENTE, ZDE.MEDIDA, JOU.VCRNUMORI_0
ORDER BY STOFCY_0, FECHA, ITMREF_0</sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>128</xloc>
      <yloc>320</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table output</name>
    <type>TableOutput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>MySQL</connection>
    <schema>mariodb</schema>
    <table>CONSUMOS_FABRICA</table>
    <commit>1000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field />
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field />
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field />
    <fields>
    </fields>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>704</xloc>
      <yloc>16</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table output 2</name>
    <type>TableOutput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>MySQL</connection>
    <schema>mariodb</schema>
    <table>CONSUMOS_PROTER</table>
    <commit>1000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field />
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field />
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field />
    <fields>
    </fields>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>704</xloc>
      <yloc>192</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Table output 2 2</name>
    <type>TableOutput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>MySQL</connection>
    <schema>mariodb</schema>
    <table>CONSUMOS_PROTER_DET</table>
    <commit>1000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>N</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field />
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field />
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field />
    <fields>
    </fields>
    <attributes />
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>704</xloc>
      <yloc>320</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
  <attributes />
</transformation>
